<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="d-flex align-items-center mb-4">
        <%= link_to root_path, class: "btn btn-outline-secondary me-3" do %>
          <i class="fas fa-arrow-left"></i>
        <% end %>
        <h1 class="mb-0"><i class="fas fa-building"></i> Configurações da Empresa</h1>
      </div>

      <%= form_with(model: @company_setting, url: company_settings_path, method: :patch, local: true, multipart: true, class: "needs-validation") do |f| %>
        <% if @company_setting.errors.any? %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">
              <i class="fas fa-exclamation-triangle"></i>
              <%= pluralize(@company_setting.errors.count, "erro") %> impediram que as configurações fossem salvas:
            </h4>
            <ul class="mb-0">
              <% @company_setting.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% end %>

        <!-- Logo da Empresa -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-image"></i> Logo da Empresa</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= f.label :logo, "Upload de Logo", class: "form-label" %>
                  <%= f.file_field :logo, 
                      accept: "image/png,image/jpeg,image/gif,image/svg+xml",
                      class: "form-control" %>
                  <small class="form-text text-muted">
                    Formatos aceitos: PNG, JPG, GIF, SVG (máximo 2MB)
                  </small>
                </div>

                <% if @company_setting.has_logo? %>
                  <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> Logo atual:</strong>
                    <%= @company_setting.logo_filename %>
                    <br>
                    <small>Tamanho: <%= number_to_human_size(@company_setting.logo_data.bytesize) %></small>
                  </div>
                <% else %>
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Nenhuma logo cadastrada
                  </div>
                <% end %>
              </div>

              <div class="col-md-6">
                <% if @company_setting.has_logo? %>
                  <div class="text-center">
                    <p class="mb-2"><strong>Pré-visualização:</strong></p>
                    <div class="border p-3 bg-light rounded">
                      <%= image_tag show_logo_company_settings_path, 
                          style: "max-width: 100%; max-height: 200px;",
                          class: "img-fluid",
                          alt: "Logo da Empresa" %>
                    </div>
                    <div class="mt-3">
                      <%= link_to remove_logo_company_settings_path, 
                          method: :delete,
                          data: { confirm: "Tem certeza que deseja remover a logo?" },
                          class: "btn btn-danger btn-sm" do %>
                        <i class="fas fa-trash"></i> Remover Logo
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <div class="text-center text-muted p-4 border rounded bg-light">
                    <i class="fas fa-image fa-4x mb-3"></i>
                    <p>Nenhuma logo cadastrada.<br>Faça upload de uma imagem.</p>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Informações da Empresa -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informações da Empresa</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <%= f.label :company_name, "Nome da Empresa", class: "form-label" %>
                  <%= f.text_field :company_name, 
                      class: "form-control", 
                      placeholder: "Ex: Minha Empresa Tech" %>
                  <small class="form-text text-muted">Nome que aparecerá nos relatórios e PDFs</small>
                </div>
              </div>

              <div class="col-md-4">
                <div class="mb-3">
                  <%= f.label :cnpj, "CNPJ", class: "form-label" %>
                  <%= f.text_field :cnpj, 
                      class: "form-control cnpj-mask", 
                      placeholder: "00.000.000/0000-00",
                      maxlength: "18" %>
                  <small class="form-text text-muted">
                    <% if @company_setting.cnpj.present? %>
                      <span class="text-success"><i class="fas fa-check-circle"></i> CNPJ válido</span>
                    <% else %>
                      Formato: XX.XXX.XXX/XXXX-XX
                    <% end %>
                  </small>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :address, "Endereço", class: "form-label" %>
              <%= f.text_area :address, 
                  class: "form-control", 
                  rows: 3,
                  placeholder: "Rua, número, bairro, cidade, estado, CEP" %>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= f.label :phone, "Telefone", class: "form-label" %>
                  <%= f.text_field :phone, 
                      class: "form-control", 
                      placeholder: "(11) 98765-4321" %>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <%= f.label :email, "Email", class: "form-label" %>
                  <%= f.email_field :email, 
                      class: "form-control", 
                      placeholder: "contato@empresa.com" %>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <%= f.label :website, "Website", class: "form-label" %>
              <%= f.text_field :website, 
                  class: "form-control", 
                  placeholder: "https://www.empresa.com" %>
            </div>
          </div>
        </div>

        <!-- Botões -->
        <div class="d-flex gap-2 mb-4">
          <%= f.submit "Salvar Configurações", class: "btn btn-primary" do %>
            <i class="fas fa-save"></i>
          <% end %>
          <%= link_to root_path, class: "btn btn-secondary" do %>
            <i class="fas fa-times"></i> Cancelar
          <% end %>
        </div>
      <% end %>

      <!-- Informações adicionais -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-question-circle"></i> Onde a logo aparece?</h5>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li><strong>PDFs de Ordens de Serviço:</strong> Logo aparece no cabeçalho</li>
            <li><strong>Relatórios em PDF:</strong> Logo aparece no topo do documento</li>
            <li><strong>Emails:</strong> Logo pode ser incluída em notificações (futuro)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Preview da imagem antes do upload
  document.querySelector('input[type="file"]').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      // Validar tamanho
      const maxSize = 2 * 1024 * 1024; // 2MB
      if (file.size > maxSize) {
        alert('Arquivo muito grande! O tamanho máximo é 2MB.');
        e.target.value = '';
        return;
      }

      // Validar tipo
      const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/svg+xml'];
      if (!allowedTypes.includes(file.type)) {
        alert('Formato não suportado! Use PNG, JPG, GIF ou SVG.');
        e.target.value = '';
        return;
      }
    }
  });

  // Máscara para CNPJ
  document.addEventListener('DOMContentLoaded', function() {
    const cnpjInput = document.querySelector('.cnpj-mask');
    
    if (cnpjInput) {
      cnpjInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length > 14) {
          value = value.substr(0, 14);
        }
        
        // Aplica máscara: XX.XXX.XXX/XXXX-XX
        if (value.length > 12) {
          value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2}).*/, '$1.$2.$3/$4-$5');
        } else if (value.length > 8) {
          value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{1,4}).*/, '$1.$2.$3/$4');
        } else if (value.length > 5) {
          value = value.replace(/^(\d{2})(\d{3})(\d{1,3}).*/, '$1.$2.$3');
        } else if (value.length > 2) {
          value = value.replace(/^(\d{2})(\d{1,3}).*/, '$1.$2');
        }
        
        e.target.value = value;
      });

      // Validação em tempo real
      cnpjInput.addEventListener('blur', function(e) {
        const value = e.target.value.replace(/\D/g, '');
        
        if (value.length > 0 && value.length !== 14) {
          const helpText = e.target.parentElement.querySelector('small');
          if (helpText) {
            helpText.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> CNPJ incompleto (14 dígitos necessários)</span>';
          }
        } else if (value.length === 14) {
          if (validateCNPJ(value)) {
            const helpText = e.target.parentElement.querySelector('small');
            if (helpText) {
              helpText.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> CNPJ válido</span>';
            }
          } else {
            const helpText = e.target.parentElement.querySelector('small');
            if (helpText) {
              helpText.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> CNPJ inválido</span>';
            }
          }
        }
      });
    }
  });

  // Função para validar CNPJ
  function validateCNPJ(cnpj) {
    // Remove caracteres não numéricos
    cnpj = cnpj.replace(/\D/g, '');
    
    // Verifica se tem 14 dígitos
    if (cnpj.length !== 14) return false;
    
    // Verifica se todos os dígitos são iguais
    if (/^(\d)\1+$/.test(cnpj)) return false;
    
    // Valida primeiro dígito verificador
    let sum = 0;
    let weights = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
    
    for (let i = 0; i < 12; i++) {
      sum += parseInt(cnpj[i]) * weights[i];
    }
    
    let remainder = sum % 11;
    let firstDigit = remainder < 2 ? 0 : 11 - remainder;
    
    if (firstDigit !== parseInt(cnpj[12])) return false;
    
    // Valida segundo dígito verificador
    sum = 0;
    weights = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
    
    for (let i = 0; i < 13; i++) {
      sum += parseInt(cnpj[i]) * weights[i];
    }
    
    remainder = sum % 11;
    let secondDigit = remainder < 2 ? 0 : 11 - remainder;
    
    return secondDigit === parseInt(cnpj[13]);
  }
</script>
