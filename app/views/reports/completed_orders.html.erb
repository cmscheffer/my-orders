<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1><i class="fas fa-check-circle"></i> Relatório de Ordens Concluídas</h1>
      <p class="text-muted mb-0">Análise detalhada de ordens de serviço finalizadas</p>
    </div>
    <div>
      <%= link_to reports_path, class: "btn btn-secondary" do %>
        <i class="fas fa-arrow-left"></i> Voltar
      <% end %>
      <%= link_to completed_orders_reports_path(format: :pdf, technician_id: params[:technician_id], start_date: params[:start_date], end_date: params[:end_date]), 
                  class: "btn btn-danger", 
                  target: "_blank" do %>
        <i class="fas fa-file-pdf"></i> Exportar PDF
      <% end %>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-filter"></i> Filtros</h5>
    </div>
    <div class="card-body">
      <%= form_with url: completed_orders_reports_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-4">
          <%= f.label :technician_id, "Técnico", class: "form-label" %>
          <%= f.collection_select :technician_id,
                                  Technician.all.order(:name),
                                  :id,
                                  :name,
                                  { prompt: "Todos os técnicos" },
                                  class: "form-select" %>
        </div>

        <div class="col-md-3">
          <%= f.label :start_date, "Data Inicial", class: "form-label" %>
          <%= f.date_field :start_date, 
              value: @start_date,
              class: "form-control" %>
        </div>

        <div class="col-md-3">
          <%= f.label :end_date, "Data Final", class: "form-label" %>
          <%= f.date_field :end_date, 
              value: @end_date,
              class: "form-control" %>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <%= f.submit "Filtrar", class: "btn btn-primary w-100" %>
        </div>
      <% end %>

      <% if params[:technician_id].present? || params[:start_date].present? || params[:end_date].present? %>
        <div class="mt-3">
          <%= link_to completed_orders_reports_path, class: "btn btn-outline-secondary btn-sm" do %>
            <i class="fas fa-times"></i> Limpar Filtros
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Informações dos Filtros Ativos -->
  <% if @selected_technician || @start_date || @end_date %>
    <div class="alert alert-info">
      <strong><i class="fas fa-info-circle"></i> Filtros Ativos:</strong>
      <% if @selected_technician %>
        <span class="badge bg-primary ms-2">Técnico: <%= @selected_technician.name %></span>
      <% end %>
      <% if @start_date %>
        <span class="badge bg-primary ms-2">De: <%= Date.parse(@start_date).strftime('%d/%m/%Y') %></span>
      <% end %>
      <% if @end_date %>
        <span class="badge bg-primary ms-2">Até: <%= Date.parse(@end_date).strftime('%d/%m/%Y') %></span>
      <% end %>
    </div>
  <% end %>

  <!-- Cards de Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body text-center">
          <h4 class="mb-0"><%= @statistics[:total_orders] %></h4>
          <p class="mb-0"><small>Total de Ordens</small></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body text-center">
          <h4 class="mb-0"><%= number_to_currency(@statistics[:total_revenue], unit: "R$ ", separator: ",", delimiter: ".") %></h4>
          <p class="mb-0"><small>Receita Total</small></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body text-center">
          <h4 class="mb-0"><%= number_to_currency(@statistics[:average_order_value], unit: "R$ ", separator: ",", delimiter: ".") %></h4>
          <p class="mb-0"><small>Ticket Médio</small></p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body text-center">
          <h4 class="mb-0"><%= @statistics[:paid_orders] %> / <%= @statistics[:total_orders] %></h4>
          <p class="mb-0"><small>Ordens Pagas</small></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Estatísticas Detalhadas -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Análise Financeira</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tbody>
              <tr>
                <td><strong>Valor Total em Serviços:</strong></td>
                <td class="text-end"><%= number_to_currency(@statistics[:total_service_value], unit: "R$ ", separator: ",", delimiter: ".") %></td>
              </tr>
              <tr>
                <td><strong>Valor Total em Peças:</strong></td>
                <td class="text-end"><%= number_to_currency(@statistics[:total_parts_value], unit: "R$ ", separator: ",", delimiter: ".") %></td>
              </tr>
              <tr class="table-success">
                <td><strong>Receita Total:</strong></td>
                <td class="text-end"><strong><%= number_to_currency(@statistics[:total_revenue], unit: "R$ ", separator: ",", delimiter: ".") %></strong></td>
              </tr>
              <tr>
                <td><strong>Total Recebido:</strong></td>
                <td class="text-end text-success"><%= number_to_currency(@statistics[:total_paid], unit: "R$ ", separator: ",", delimiter: ".") %></td>
              </tr>
              <tr>
                <td><strong>Pendente de Pagamento:</strong></td>
                <td class="text-end text-warning"><%= number_to_currency(@statistics[:total_pending], unit: "R$ ", separator: ",", delimiter: ".") %></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-credit-card"></i> Status de Pagamento</h5>
        </div>
        <div class="card-body">
          <canvas id="paymentChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Estatísticas por Técnico (se não houver filtro de técnico) -->
  <% unless @selected_technician %>
    <% if @technician_stats.any? %>
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-user-cog"></i> Ordens por Técnico</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <% @technician_stats.first(6).each do |stat| %>
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title"><%= stat[:technician].name %></h6>
                    <p class="card-text">
                      <span class="badge bg-primary"><%= stat[:count] %> ordens</span>
                      <% if stat[:technician].specialty %>
                        <br><small class="text-muted"><%= stat[:technician].specialty %></small>
                      <% end %>
                    </p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- Top 5 Peças Mais Utilizadas -->
  <% if @top_parts.any? %>
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-wrench"></i> Top 5 Peças Mais Utilizadas</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Peça</th>
                <th>Categoria</th>
                <th class="text-center">Quantidade Total</th>
                <th class="text-end">Receita Total</th>
              </tr>
            </thead>
            <tbody>
              <% @top_parts.each_with_index do |item, index| %>
                <tr>
                  <td><strong><%= index + 1 %>º</strong></td>
                  <td><%= item[:part].name %></td>
                  <td><span class="badge bg-info"><%= item[:part].category %></span></td>
                  <td class="text-center"><strong><%= item[:quantity] %></strong></td>
                  <td class="text-end"><%= number_to_currency(item[:revenue], unit: "R$ ", separator: ",", delimiter: ".") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Tabela de Ordens -->
  <div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-list"></i> Ordens Concluídas (<%= @service_orders.count %>)</h5>
      <small>Ordenadas por data de conclusão (mais recentes primeiro)</small>
    </div>
    <div class="card-body">
      <% if @service_orders.any? %>
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Título</th>
                <th>Cliente</th>
                <th>Técnico</th>
                <th>Concluída em</th>
                <th class="text-end">Valor</th>
                <th>Pagamento</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <% @service_orders.each do |order| %>
                <tr>
                  <td><strong>#<%= order.id %></strong></td>
                  <td><%= order.title %></td>
                  <td><%= order.customer_name || "-" %></td>
                  <td>
                    <% if order.technician %>
                      <small><%= order.technician.name %></small>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td><%= l(order.completed_at, format: :short) if order.completed_at %></td>
                  <td class="text-end"><strong><%= number_to_currency(order.total_value || 0, unit: "R$ ", separator: ",", delimiter: ".") %></strong></td>
                  <td>
                    <% if order.payment_status %>
                      <span class="badge <%= order.payment_status_badge_class %>">
                        <%= order.payment_status.humanize %>
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to service_order_path(order), class: "btn btn-sm btn-info", title: "Ver" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to pdf_service_order_path(order), class: "btn btn-sm btn-danger", target: "_blank", title: "PDF" do %>
                      <i class="fas fa-file-pdf"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="5" class="text-end">TOTAL:</th>
                <th class="text-end"><%= number_to_currency(@statistics[:total_revenue], unit: "R$ ", separator: ",", delimiter: ".") %></th>
                <th colspan="2"></th>
              </tr>
            </tfoot>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info mb-0">
          <i class="fas fa-info-circle"></i> Nenhuma ordem concluída encontrada com os filtros selecionados.
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Script para gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Gráfico de Status de Pagamento
  const paymentCtx = document.getElementById('paymentChart').getContext('2d');
  new Chart(paymentCtx, {
    type: 'doughnut',
    data: {
      labels: ['Pagas', 'Pendentes'],
      datasets: [{
        data: [<%= @statistics[:paid_orders] %>, <%= @statistics[:pending_payment] %>],
        backgroundColor: ['#28a745', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
</script>
