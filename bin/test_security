#!/bin/bash
# Script para testar configura√ß√µes de seguran√ßa
# Uso: ./bin/test_security

echo "üîí TESTANDO CONFIGURA√á√ïES DE SEGURAN√áA"
echo "======================================="
echo ""

# Verificar se o servidor est√° rodando
if ! curl -s http://localhost:3000 > /dev/null; then
    echo "‚ùå ERRO: Servidor n√£o est√° rodando em http://localhost:3000"
    echo "   Execute: rails server -b 0.0.0.0 -p 3000"
    exit 1
fi

echo "‚úÖ Servidor rodando"
echo ""

# Teste 1: Headers de seguran√ßa
echo "üìã Teste 1: Verificando Security Headers"
echo "-----------------------------------------"

HEADERS=$(curl -sI http://localhost:3000/)

check_header() {
    header_name=$1
    expected_value=$2
    
    if echo "$HEADERS" | grep -qi "$header_name: $expected_value"; then
        echo "  ‚úÖ $header_name: OK"
    else
        echo "  ‚ùå $header_name: AUSENTE ou INCORRETO"
        echo "     Esperado: $expected_value"
    fi
}

check_header "X-Frame-Options" "DENY"
check_header "X-Content-Type-Options" "nosniff"
check_header "X-XSS-Protection" "1; mode=block"
check_header "Referrer-Policy" "origin-when-cross-origin"

if echo "$HEADERS" | grep -qi "Content-Security-Policy"; then
    echo "  ‚úÖ Content-Security-Policy: OK"
else
    echo "  ‚ùå Content-Security-Policy: AUSENTE"
fi

echo ""

# Teste 2: Rate Limiting de Login
echo "üö¶ Teste 2: Rate Limiting de Login (5 tentativas)"
echo "--------------------------------------------------"

SUCCESS_COUNT=0
FAIL_COUNT=0

for i in {1..6}; do
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/users/sign_in \
        -d "user[email]=test@example.com" \
        -d "user[password]=wrongpassword" \
        -H "Content-Type: application/x-www-form-urlencoded")
    
    if [ "$RESPONSE" = "429" ]; then
        echo "  Tentativa $i: üõë BLOQUEADO (HTTP 429) - Rate limit funcionando!"
        FAIL_COUNT=$((FAIL_COUNT + 1))
    else
        echo "  Tentativa $i: ‚úÖ Permitido (HTTP $RESPONSE)"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    fi
    
    sleep 0.5
done

echo ""
if [ $FAIL_COUNT -gt 0 ]; then
    echo "  ‚úÖ Rate limiting est√° FUNCIONANDO!"
    echo "     $SUCCESS_COUNT requisi√ß√µes permitidas, $FAIL_COUNT bloqueadas"
else
    echo "  ‚ö†Ô∏è  AVISO: Nenhuma requisi√ß√£o foi bloqueada"
    echo "     Verifique se o Rack Attack est√° configurado corretamente"
fi

echo ""

# Teste 3: Rate Limiting Geral (simplificado)
echo "üåê Teste 3: Rate Limiting Geral (20 requisi√ß√µes)"
echo "-------------------------------------------------"

BLOCKED=0
for i in {1..20}; do
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
    
    if [ "$RESPONSE" = "429" ]; then
        BLOCKED=$((BLOCKED + 1))
    fi
    
    # Mostrar progresso a cada 5 requisi√ß√µes
    if [ $((i % 5)) -eq 0 ]; then
        echo "  Progresso: $i/20 requisi√ß√µes..."
    fi
done

echo ""
if [ $BLOCKED -eq 0 ]; then
    echo "  ‚úÖ Requisi√ß√µes gerais permitidas (abaixo do limite)"
    echo "     Para testar o limite completo, fa√ßa 300+ requisi√ß√µes"
else
    echo "  üõë Algumas requisi√ß√µes foram bloqueadas: $BLOCKED/20"
fi

echo ""

# Teste 4: Prote√ß√£o contra Clickjacking
echo "üñºÔ∏è  Teste 4: Prote√ß√£o contra Clickjacking"
echo "----------------------------------------"

XFRAME=$(echo "$HEADERS" | grep -i "x-frame-options" | grep -i "deny")
if [ ! -z "$XFRAME" ]; then
    echo "  ‚úÖ X-Frame-Options: DENY est√° ativo"
    echo "     Seu site N√ÉO pode ser embedado em iframes"
else
    echo "  ‚ùå X-Frame-Options n√£o est√° configurado corretamente"
fi

echo ""

# Teste 5: Content Security Policy
echo "üõ°Ô∏è  Teste 5: Content Security Policy"
echo "------------------------------------"

CSP=$(echo "$HEADERS" | grep -i "content-security-policy")
if [ ! -z "$CSP" ]; then
    echo "  ‚úÖ CSP est√° ativo"
    
    if echo "$CSP" | grep -q "default-src 'self'"; then
        echo "  ‚úÖ default-src 'self' configurado"
    fi
    
    if echo "$CSP" | grep -q "script-src"; then
        echo "  ‚úÖ script-src configurado"
    fi
    
    if echo "$CSP" | grep -q "object-src 'none'"; then
        echo "  ‚úÖ object-src 'none' (bloqueando Flash/Java)"
    fi
else
    echo "  ‚ùå CSP n√£o est√° configurado"
fi

echo ""

# Resumo Final
echo "üìä RESUMO DOS TESTES"
echo "===================="
echo ""
echo "Security Headers:"
echo "  ‚Ä¢ X-Frame-Options: $(echo "$HEADERS" | grep -i "x-frame-options" | cut -d: -f2 | xargs)"
echo "  ‚Ä¢ X-Content-Type-Options: $(echo "$HEADERS" | grep -i "x-content-type-options" | cut -d: -f2 | xargs)"
echo "  ‚Ä¢ CSP: $(echo "$HEADERS" | grep -qi "content-security-policy" && echo "Ativo" || echo "Inativo")"
echo ""
echo "Rate Limiting:"
echo "  ‚Ä¢ Login: $([ $FAIL_COUNT -gt 0 ] && echo "‚úÖ Funcionando" || echo "‚ö†Ô∏è  Verificar")"
echo "  ‚Ä¢ Geral: $([ $BLOCKED -eq 0 ] && echo "‚úÖ Abaixo do limite" || echo "üõë $BLOCKED bloqueadas")"
echo ""
echo "üéâ Testes conclu√≠dos!"
echo ""
echo "Para mais detalhes, veja: SECURITY.md"
